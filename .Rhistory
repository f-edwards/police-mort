select(RptFIPS, chpov, chpop))
?sample
ncands<-sample_frac(ncands, 0.01)
gc()
rm(list=ls())
gc()
?fread
rm(list=ls())
gc()
library(data.table)
library(curl)
library(dplyr)
library(ggplot2)
library(tidyr)
library(jsonlite)
install.packages("rlang")
install.packages("tibble")
library(dplyr)
rm(list=ls())
gc()
library(data.table)
library(curl)
library(dplyr)
library(ggplot2)
library(tidyr)
library(jsonlite)
library(data.table)
library(dplyr)
library(tidyr)
rm(list=ls())
gc()
library(data.table)
library(dplyr)
library(tidyr)
dat<-fread("C:/Users/fre9/Downloads/data/afcars/afcars-deport00-15.csv")
head(dat)
table(dat$HISORGIN)
TS<-dat%>%
group_by(STATE, FY)%>%
summarise(total.cases=n(),
prop.missing=sum(HISORGIN==3)/n(),
prop.lat=sum(HISORGIN==1)/n())
TS
ggplot(TS, aes(x=FY, y=prop.missing))+
geom_line()+
facet_wrap(~STATE)
ts<-ggplot(TS, aes(x=FY, y=prop.missing))+
geom_line()+
facet_wrap(~STATE)
ggsave(ts, "c:/ts.pdf")
ggsave("c:/ts.pdf", ts)
ggsave("c:/Users/fre9/Documents/ts.pdf", ts)
ggsave("c:/Users/fre9/Documents/ts.pdf", ts, width=10, height=10)
library(data.table)
library(dplyr)
library(tidyr)
dat<-bind_rows(fread("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Text Files/FC2015v2.tab"),
fread("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Text Files/FC2014v4.tab"))
head(dat)
library(haven)
library(data.table)
library(dplyr)
library(tidyr)
library(haven)
dat<-bind_rows(read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta"),
read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Stata Files/FC2014v4.dta"))
warnings()
head(dat)
dat<-read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta")
head(dat)
View(dat)
head(Dat)
head(dat)
head(dat$raceethn)
head(as.character(dat$raceethn))
str(dat$raceethn)
names(dat$raceethn)
labels)dat$raceethn
labels(dat$raceethn)
names(as_factor(dat$raceethn))
(as_factor(dat$raceethn))
head((as_factor(dat$raceethn)))
head(as.character((as_factor(dat$raceethn))))
is.labelled(dat)
is.labelled(dat$raceethn)
sapply(dat, is.labelled)
which(sapply(dat, is.labelled)==TRUE)
which(sapply(dat, is.labelled)==TRUE)[1,]
which(sapply(dat, is.labelled)==TRUE)[1]
labels_to_values<-function(x){
labelled_columns<-which(sapply(x, is.labelled)==TRUE)
for(i in labelled_columns){
x[i,]<-as_factor(x[i,])
}
return(x)
}
test<-labels_to_values(dat)
str(test$raceethn)
dat<-x
x<-dat
head(x)
labelled_columns<-which(sapply(x, is.labelled)==TRUE)
labelled_columns
i]
i
for(i in labelled_columns)
for(i in labelled_columns){
# x[i,]<-as_factor(x[i,])
}
i
x[i,]<-as_factor(x[i,])
str(x[i,])
x<-dat
labels_to_values<-function(x){
labelled_columns<-which(sapply(x, is.labelled)==TRUE)
for(i in labelled_columns){
x[,i]<-as_factor(x[,i])
}
return(x)
}
dat<-labels_to_values(
read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta"))
str(dat$raceethn)
dat<-bind_rows(
labels_to_values(
read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta")),
labels_to_values(
read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Stata Files/FC2014v4.dta")
)
)
warnings()
head(dat)
?summarise_all
head(dat$entered)
dat%>%
group_by(fy, St, FIPSCODE, RaceEthn)%>%
select(entered, served, iswaiting)%>%
summarise_all(function(x)sum(x=="Yes"))
dat%>%
group_by(fy, state, fipscode, raceethn)%>%
select(entered, served, iswaiting)%>%
summarise_all(function(x)sum(x=="Yes"))
dat%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(entered, served, iswaiting, phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))
dat%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))
?gather
dat%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements)
dat%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))
dat%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(entered, served, iswaiting, phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))
dat%>%
filter(entered=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Entered")
dat%>%
filter(entered=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Entered")%>%
left_join(dat%>%
filter(served=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Served"))%>%
left_join(dat%>%
filter(iswaiting=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Waiting for adoption"))
long_file<-dat%>%
filter(entered=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Entered")%>%
left_join(dat%>%
filter(served=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Served"))%>%
left_join(dat%>%
filter(iswaiting=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Waiting for adoption"))
head(long_file)
?write.csv
write.csv(long_file, file="C:/Users\fre9/Box Sync/shiny", row.names = FALSE)
library(data.table)
library(dplyr)
library(tidyr)
library(haven)
### haven returns stata 'labelled' column class, this converts to factor
labels_to_values<-function(x){
labelled_columns<-which(sapply(x, is.labelled)==TRUE)
for(i in labelled_columns){
x[,i]<-as_factor(x[,i])
}
return(x)
}
### read stata files to preserve labels for pretty tables
dat<-bind_rows(
labels_to_values(
read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta")),
labels_to_values(
read_dta("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Stata Files/FC2014v4.dta")
)
)
### aggregate caseloads, entries, waiting for adoption by year, race, county, placement setting
### add remreason, then spread to make data more compact
#### filter by entered, served, iswaiting for by rem_reason for each
long_file<-dat%>%
filter(entered=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Entered")%>%
left_join(dat%>%
filter(served=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Served"))%>%
left_join(dat%>%
filter(iswaiting=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Waiting for adoption"))
write.csv(long_file, file="C:/Users/fre9/Box Sync/shiny", row.names = FALSE)
write.csv(long_file, file="C:/Users/fre9/Box Sync/shiny/afcars_long.csv", row.names = FALSE)
write.csv(long_file, file="C:/Users/fre9/Box Sync/shiny/afcars_long_test.csv", row.names = FALSE)
paths<-c("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Stata Files/FC2014v4.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2013 AFCARS FosterCare DS_187\DS187 Distributable\Data\Stata Files\FC2013v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2012 AFCARS FosterCare DS_176\DS176 Distributable\Data\Stata Files\FC2012v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2011 AFCARS FosterCare DS_167\DS167 Distributable\Data\Stata Files\FC2011v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2010 AFCARS FosterCare DS_163\163 Distributable\Data\Stata Files\FC2010v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2009 AFCARS FosterCare DS_153\153 Distributable\Data\Stata Files\FC2009v4.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2008 AFCARS FosterCare DS_149\149 Distributable\Data\Stata Files\FC2008v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2007 AFCARS FosterCare DS_143\143 Distributable\Data\Stata Files\FC2007v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2006 AFCARS FosterCare DS_137\137 Distributable\Data\Stata Files\FC2006v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2005 AFCARS FosterCare DS_131\131 Distributable\Data\Stata Files\FC2005v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2004 AFCARS FosterCare DS_124\124 Distributable\Data\Stata\FC2004v6.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2003 AFCARS FosterCare DS_118\118 Distributable\Data\Stata Files\FC2003v7.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2002 AFCARS FosterCare DS_105\105 Distributable\Data\Stata files\FC2002v8.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2001 AFCARS FosterCare DS_101\101 Distributable\Data\Stata files\FC2001v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2000 AFCARS FosterCare DS_097\097 Distributable\Data\Stata\FC2000v5.dta"
)
paths<-c("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Stata Files/FC2014v4.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2013 AFCARS FosterCare DS_187\DS187 Distributable\Data\Stata Files\FC2013v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2012 AFCARS FosterCare DS_176\DS176 Distributable\Data\Stata Files\FC2012v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2011 AFCARS FosterCare DS_167\DS167 Distributable\Data\Stata Files\FC2011v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2010 AFCARS FosterCare DS_163\163 Distributable\Data\Stata Files\FC2010v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2009 AFCARS FosterCare DS_153\153 Distributable\Data\Stata Files\FC2009v4.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2008 AFCARS FosterCare DS_149\149 Distributable\Data\Stata Files\FC2008v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2007 AFCARS FosterCare DS_143\143 Distributable\Data\Stata Files\FC2007v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2006 AFCARS FosterCare DS_137\137 Distributable\Data\Stata Files\FC2006v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2005 AFCARS FosterCare DS_131\131 Distributable\Data\Stata Files\FC2005v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2004 AFCARS FosterCare DS_124\124 Distributable\Data\Stata\FC2004v6.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2003 AFCARS FosterCare DS_118\118 Distributable\Data\Stata Files\FC2003v7.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2002 AFCARS FosterCare DS_105\105 Distributable\Data\Stata files\FC2002v8.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2001 AFCARS FosterCare DS_101\101 Distributable\Data\Stata files\FC2001v5.dta",
"Q:\NDACAN\Holdings\Data\AFCARS\_Foster Care Annual Files\2000 AFCARS FosterCare DS_097\097 Distributable\Data\Stata\FC2000v5.dta"
)
paths<-c("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Stata Files/FC2014v4.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2013 AFCARS FosterCare DS_187/DS187 Distributable/Data/Stata Files/FC2013v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2012 AFCARS FosterCare DS_176/DS176 Distributable/Data/Stata Files/FC2012v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2011 AFCARS FosterCare DS_167/DS167 Distributable/Data/Stata Files/FC2011v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2010 AFCARS FosterCare DS_163/163 Distributable/Data/Stata Files/FC2010v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2009 AFCARS FosterCare DS_153/153 Distributable/Data/Stata Files/FC2009v4.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2008 AFCARS FosterCare DS_149/149 Distributable/Data/Stata Files/FC2008v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2007 AFCARS FosterCare DS_143/143 Distributable/Data/Stata Files/FC2007v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2006 AFCARS FosterCare DS_137/137 Distributable/Data/Stata Files/FC2006v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2005 AFCARS FosterCare DS_131/131 Distributable/Data/Stata Files/FC2005v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2004 AFCARS FosterCare DS_124/124 Distributable/Data/Stata/FC2004v6.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2003 AFCARS FosterCare DS_118/118 Distributable/Data/Stata Files/FC2003v7.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2002 AFCARS FosterCare DS_105/105 Distributable/Data/Stata files/FC2002v8.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2001 AFCARS FosterCare DS_101/101 Distributable/Data/Stata files/FC2001v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2000 AFCARS FosterCare DS_097/097 Distributable/Data/Stata/FC2000v5.dta"
)
paths
dat<-labels_to_values(
read_dta(paths[1]))
rm(list(dat, long_file))
gc()
rm(dat); rm(long_file)
gc()
?gc()
library(data.table)
library(dplyr)
library(tidyr)
library(haven)
### haven returns stata 'labelled' column class, this converts to factor
labels_to_values<-function(x){
names(x)<-tolower(names(x))
labelled_columns<-which(sapply(x, is.labelled)==TRUE)
for(i in labelled_columns){
x[,i]<-as_factor(x[,i])
}
return(x)
}
### read stata files to preserve labels for pretty tables
paths<-c("Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2014 AFCARS FosterCare DS_192/DS192 Distributable/Data/Stata Files/FC2014v4.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2013 AFCARS FosterCare DS_187/DS187 Distributable/Data/Stata Files/FC2013v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2012 AFCARS FosterCare DS_176/DS176 Distributable/Data/Stata Files/FC2012v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2011 AFCARS FosterCare DS_167/DS167 Distributable/Data/Stata Files/FC2011v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2010 AFCARS FosterCare DS_163/163 Distributable/Data/Stata Files/FC2010v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2009 AFCARS FosterCare DS_153/153 Distributable/Data/Stata Files/FC2009v4.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2008 AFCARS FosterCare DS_149/149 Distributable/Data/Stata Files/FC2008v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2007 AFCARS FosterCare DS_143/143 Distributable/Data/Stata Files/FC2007v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2006 AFCARS FosterCare DS_137/137 Distributable/Data/Stata Files/FC2006v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2005 AFCARS FosterCare DS_131/131 Distributable/Data/Stata Files/FC2005v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2004 AFCARS FosterCare DS_124/124 Distributable/Data/Stata/FC2004v6.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2003 AFCARS FosterCare DS_118/118 Distributable/Data/Stata Files/FC2003v7.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2002 AFCARS FosterCare DS_105/105 Distributable/Data/Stata files/FC2002v8.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2001 AFCARS FosterCare DS_101/101 Distributable/Data/Stata files/FC2001v5.dta",
"Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2000 AFCARS FosterCare DS_097/097 Distributable/Data/Stata/FC2000v5.dta"
)
for(j in paths){
dat<-labels_to_values(
read_dta(j))
### aggregate caseloads, entries, waiting for adoption by year, race, county, placement setting
### add remreason, then spread to make data more compact
#### filter by entered, served, iswaiting for by rem_reason for each
long_file<-dat%>%
filter(entered=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Entered")%>%
left_join(dat%>%
filter(served=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Served"))%>%
left_join(dat%>%
filter(iswaiting=="Yes")%>%
group_by(fy, state, fipscode, raceethn, curplset)%>%
select(phyabuse:housing)%>%
summarise_all(function(x)sum(x=="Yes"))%>%
gather(key=rem_reason, value=placements, -c(fy, state, fipscode, raceethn, curplset))%>%
mutate(cl_type="Waiting for adoption"))
if(j=="Q:/NDACAN/Holdings/Data/AFCARS/_Foster Care Annual Files/2015 AFCARS FosterCare DS_200/DS200 Distributable/Data/Stata Files/FC2015v2.dta"){
write.csv(long_file, file="C:/Users/fre9/Box Sync/shiny/afcars_long_test.csv", row.names = FALSE, append = FALSE)}
else{
write.csv(long_file, file="C:/Users/fre9/Box Sync/shiny/afcars_long.csv", row.names = FALSE, append = TRUE)}
rm(dat); rm(long_file)
gc()
}
shiny::runApp('C:/Users/fre9/Box Sync/shiny/portal/AFCARS-table')
getwd()
source('C:/Users/fre9/Box Sync/police-mort/more_descriptives.r', echo=TRUE)
load("models.RData")
load("C:/Users/fre9/Box Sync/police-mort/models.RData")
shiny::runApp('C:/Users/fre9/Box Sync/shiny/portal/AFCARS-table')
runApp('C:/Users/fre9/Box Sync/shiny/portal/AFCARS-table')
ls()
rm(list=ls())
gc()
ls()
runApp('C:/Users/fre9/Box Sync/shiny/portal/AFCARS-table')
runApp('C:/Users/fre9/Box Sync/shiny/portal/AFCARS-table')
runApp('C:/Users/fre9/Box Sync/shiny/portal/AFCARS-table')
runApp('C:/Users/fre9/Box Sync/shiny/portal/AFCARS-table')
rm(list=ls())
gc()
set.seed(2017)
library(data.table)
library(dplyr)
setwd("C:/Users/fre9/Box Sync/shiny")
dat<-fread("afcars-long.csv",  stringsAsFactors = TRUE)
FY.comp<-unique(dat$FY)
FIPS.comp<-unique(dat$FIPSCODE)
RACE.comp<-unique(dat$RACE)
#CurPl.comp<-unique(dat$CurPlSet)
cl.comp<-unique(dat$cl_type)
complete<-expand.grid(FY.comp, FIPS.comp, RACE.comp, cl.comp)
names(complete)<-c("FY", "FIPSCODE", "RACE", "cl_type")
dat.complete<-right_join(dat, complete)
dat.complete[is.na(dat.complete)]<-0
dat.complete<-dat.complete%>%
bind_rows(dat.complete%>%
group_by(FY, FIPSCODE, cl_type)%>%
summarise(Placements=sum(Placements),
PHYABUSE=sum(PHYABUSE),
SEXABUSE=sum(SEXABUSE),
NEGLECT=sum(NEGLECT),
AAPARENT=sum(AAPARENT),
DAPARENT=sum(DAPARENT),
AACHILD=sum(AACHILD),
CHILDIS=sum(CHILDIS),
CHBEHPRB=sum(CHBEHPRB),
PRTSDIED=sum(PRTSDIED),
PRTSJAIL=sum(PRTSJAIL),
NOCOPE=sum(NOCOPE),
ABANDMNT=sum(ABANDMNT),
RELINQSH=sum(RELINQSH),
HOUSING=sum(HOUSING))%>%
mutate(RACE="Total"))
randomRound<-function(x){
base<-3
k<-x%/%base
floor_x<-k*base
res<-x-floor_x
p<-res/base
rounding<-rbinom(length(p), 1,  p)
result<-ifelse(rounding==1, floor_x+base, floor_x)
}
index<-c(which(names(dat.complete)=="Placements"),
which(names(dat.complete)=="HOUSING"))
for(j in index[1]:index[2]){
dat.complete[,j]<-randomRound(dat.complete[,j])
}
pop<-fread("seer-pop.csv", stringsAsFactors = FALSE,
data.table=FALSE)
### get state names on data
dat.complete<-dat.complete%>%
filter(FIPSCODE!="9", FIPSCODE!="NULL")
dat.complete$FIPSCODE<-as.integer(as.character(dat.complete$FIPSCODE))
dat.complete<-dat.complete%>%
left_join(pop%>%
select(FIPS, state)%>%
distinct()%>%
rename(FIPSCODE=FIPS))%>%
rename(fy=FY, FIPS=FIPSCODE)
write.csv(dat.complete, "afcars-long-round.csv", row.names = FALSE)
dat.complete<-dat.complete%>%
bind_rows(dat.complete%>%
group_by(FY, FIPSCODE, cl_type)%>%
summarise(Placements=sum(Placements),
PHYABUSE=sum(PHYABUSE),
SEXABUSE=sum(SEXABUSE),
NEGLECT=sum(NEGLECT),
AAPARENT=sum(AAPARENT),
DAPARENT=sum(DAPARENT),
AACHILD=sum(AACHILD),
CHILDIS=sum(CHILDIS),
CHBEHPRB=sum(CHBEHPRB),
PRTSDIED=sum(PRTSDIED),
PRTSJAIL=sum(PRTSJAIL),
NOCOPE=sum(NOCOPE),
ABANDMNT=sum(ABANDMNT),
RELINQSH=sum(RELINQSH),
HOUSING=sum(HOUSING))%>%
mutate(RACE="Total"))
rounding<-rbinom(length(p), 1,  p)
runApp('portal/AFCARS-table')
runApp('portal/AFCARS-table')
log(0.37) - log(100000)
exp(log(0.37) - log(100000))
exp(3.7e-06)
log(.37/100000)
plot(dnorm(-12.5, 10))
?dnorm
exp(-7.5)
exp(-7.5)*100000
exp(-15)*100000
exp(-15)*100000
exp(-22.5)*100000
exp(-32.5)*100000
-12.5+20
exp(7.5)*100000
prior.white<-normal(log(0.37) - log(100000), 10)
setwd("C:/Users/fre9/Box Sync/police-mort")
install.packages(c("ggplot2", "readr", "date", "lme4", "MASS", "rstanarm", "dplyr", "tidyr", "xtable"))
source('C:/Users/fre9/Box Sync/police-mort/main_code_sensitivity.r', echo=TRUE)
lat.stan.2
lat.stan.0
summary(lat.stan.2)
launch_shinystan(stan.lat2)
launch_shinystan(stan.lat.2)
launch_shinystan(lat.stan.2)
